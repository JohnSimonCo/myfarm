<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Simple markers</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
	<script type="text/javascript" src="/js/jr-jr1.js"></script>
	<script type="text/javascript" src="/util.js"></script>
    <script>
function initialize() {
	function getMarkerWithColor(pinColor) {
		this.pinImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + pinColor,
			new google.maps.Size(21, 34),
			new google.maps.Point(0,0),
			new google.maps.Point(10, 34));
		this.pinShadow = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_shadow",
			new google.maps.Size(40, 37),
			new google.maps.Point(0, 0),
			new google.maps.Point(12, 35));
	}
	var red = new getMarkerWithColor('C40000');
	var lred = new getMarkerWithColor('FF5757');
	var green = new getMarkerWithColor('07750E');
	var lgreen = new getMarkerWithColor('44FC50');
	jr.ajax('SyStat','getGeoInfo',null,'myConf' );
	jr.eventManager.addListener('myConf', jr.eventManager, function(d) {
		var same={},radius=360/40000;
		d.forEach(function(o){
			var dd = new JsSerilz('$', o.geoSerialized);
			o.ipAddress=	dd.getString();
			o.country=		dd.getString();
			o.region=		dd.getString();
			o.city=			dd.getString();
			o.ISP=			dd.getString();
			o.ipType=		dd.getString();
			o.latitude=		dd.getString();
			o.longitude=	dd.getString();
			var latLong=o.latitude+','+o.longitude;
			if(!same[latLong])
				same[latLong]=[];
			same[latLong].push(o);
		});
		for(var ll in same)
			if(same[ll].length>1) {
				var dd=same[ll],ld=[],v=0,vs=360/same[ll].length,i=-1;
				while(++i<same[ll].length){
					var px=Math.cos(v/180*Math.PI),py=Math.sin(v/180*Math.PI);
					px*=2*radius;
					py*=radius;
					v+=vs;
					dd[i].latitude=Number(dd[i].latitude)+py;
					dd[i].longitude=Number(dd[i].longitude)+px;
					dd[i].isSame=1;
				}
			}
		var myLatlng = new google.maps.LatLng(30,13.35);
		var mapOptions = {
			zoom: 3,
			center: myLatlng
		};
		var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

		d.forEach(function(p){
			var latLng = new google.maps.LatLng(p.latitude,p.longitude);
			var color=p.name?(p.isSame?green:lgreen):(p.isSame?red:lred);
			var marker = new google.maps.Marker({
				data:p,
				position: latLng,
				map: map,
				title: (p.name?p.name:'')+'  -- '+(p.region?p.region+', ':'')+(p.city?p.city+', ':'')+p.ISP+', '+p.ipType+', '+p.ipAddress,
				icon: color.pinImage,
				shadow: color.pinShadow
			});
			google.maps.event.addListener(marker, 'click', function(data) {
				if(marker.data.name)
					window.location='/jr-myfarm/index.html#/?id='+marker.data.vcGUID;
			});
		});
	});
}

google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
  </body>
</html>